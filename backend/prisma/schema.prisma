generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
  extensions = [vector]
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String
  createdAt    DateTime   @default(now())
  
  documents    Document[]
  feedbacks    Feedback[] // Relaci√≥n para saber qui√©n dio feedback
}

enum DocStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Document {
  id           String      @id @default(uuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id])
  
  filename     String
  originalName String
  mimeType     String
  
  status       DocStatus   @default(PENDING)
  
  // Aqu√≠ guardamos el "Structured Output" (Requisito 1.1)
  // Ej: { "summary": "...", "tags": ["AI", "Finance"] }
  metadata     Json?       
  
  content      String?     @db.Text // Texto extra√≠do crudo
  
  embeddings   Embedding[]
  createdAt    DateTime    @default(now())
}

model Embedding {
  id         String   @id @default(uuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  content    String   @db.Text // El chunk de texto espec√≠fico
  
  // IMPORTANTE: Prisma no soporta el tipo 'vector' nativamente en el schema DSL todav√≠a.
  // Usamos Unsupported para que Prisma no se rompa, y gestionaremos los vectores con raw SQL.
  vector     Unsupported("vector(768)")
  
  createdAt  DateTime @default(now())
  
  // √çndice para b√∫squeda r√°pida (IVFFlat o HNSW)
  @@index([documentId])
}

model Feedback {
  id            String   @id @default(uuid())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  
  messageId     String   // ID del mensaje del chat (generado por frontend o backend)
  isPositive    Boolean  // true = üëç, false = üëé (Requisito 2.2)
  comment       String?  // Opcional: "¬øQu√© sali√≥ mal?"
  
  // CR√çTICO para "Detect Regressions" (Requisito 2.2)
  promptVersion String   // Ej: "v1.2.0"
  modelUsed     String   // Ej: "gpt-4o-mini"
  
  createdAt     DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String   // Ej: "UPLOAD_DOCUMENT", "QUERY_LLM", "PII_REDACTION"
  details   String?  // Ej: "User uploaded confidential.pdf", "Detected Credit Card"
  status    String   // "SUCCESS", "FAILURE"
  timestamp DateTime @default(now())
}